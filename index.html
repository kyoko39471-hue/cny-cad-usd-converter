<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">SJ's Live Currency Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .input-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4" onload="initApp()">
    
    <div class="relative w-full max-w-lg">
        <!-- Language Selector -->
        <div class="absolute top-0 right-0 p-2 sm:p-0">
            <select id="language-selector" onchange="setLanguage(this.value)" 
                    class="px-2 py-1 text-xs border border-gray-300 rounded-lg bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="en">English</option>
                <option value="zh">ä¸­æ–‡</option>
            </select>
        </div>

        <div class="w-full p-8 space-y-6 bg-white rounded-xl input-card">
            <h1 id="app-title" class="text-3xl font-bold text-center text-blue-700" data-i18n="title">SJ's Live Currency Calculator</h1>
            <p id="app-subtitle" class="text-center text-gray-500" data-i18n="subtitle">Enter an amount in any currency below. Rates are fetched live!</p>

            <!-- Dynamic Rate Status/Disclaimer -->
            <div id="rate-info" class="p-3 text-sm text-center bg-yellow-100 border border-yellow-300 rounded-lg flex items-center justify-center space-x-2">
                <!-- Loading message will appear here -->
                <div id="rate-message" data-i18n-dynamic="init_rates">Initializing live rates...</div>
                <div id="loading-indicator" class="loading-spinner"></div>
            </div>

            <!-- USD Input/Output -->
            <div class="space-y-2">
                <label for="usd-input" class="block text-lg font-semibold text-gray-700" data-i18n="usd_label">United States Dollar (USD)</label>
                <input 
                    type="number" 
                    id="usd-input" 
                    min="0"
                    class="w-full p-3 text-2xl font-mono text-gray-800 border-2 border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                    placeholder="0.00"
                    oninput="convert('USD')"
                >
            </div>

            <!-- CAD Input/Output -->
            <div class="space-y-2">
                <label for="cad-input" class="block text-lg font-semibold text-gray-700" data-i18n="cad_label">Canadian Dollar (CAD)</label>
                <input 
                    type="number" 
                    id="cad-input" 
                    min="0"
                    class="w-full p-3 text-2xl font-mono text-gray-800 border-2 border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500" 
                    placeholder="0.00"
                    oninput="convert('CAD')"
                >
            </div>

            <!-- CNY Input/Output -->
            <div class="space-y-2">
                <label for="cny-input" class="block text-lg font-semibold text-gray-700" data-i18n="cny_label">Chinese Yuan (CNY)</label>
                <input 
                    type="number" 
                    id="cny-input" 
                    min="0"
                    class="w-full p-3 text-2xl font-mono text-gray-800 border-2 border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" 
                    placeholder="0.00"
                    oninput="convert('CNY')"
                >
            </div>
        </div>
    </div>

    <script>
        // --- TRANSLATION DATA ---
        const translations = {
            en: {
                title: "SJ's Live Currency Calculator",
                subtitle: "Enter an amount in any currency below. Rates are fetched live!",
                init_rates: "Initializing live rates...",
                usd_label: "United States Dollar (USD)",
                cad_label: "Canadian Dollar (CAD)",
                cny_label: "Chinese Yuan (CNY)",
                loading: (attempt) => `Fetching live rates... (Attempt ${attempt})`,
                success: "Rates updated successfully! (Source: Open Exchange Rate API)",
                error_retry: (delay, attempt) => `Failed to fetch rates. Retrying in ${delay / 1000}s... (Attempt ${attempt + 1})`,
                error_fallback: "ðŸ”´ Failed to load live rates. Using **fixed** fallback rates.",
                loading_wait: "Please wait, rates are still loading...",
            },
            zh: {
                title: "SJçš„å®žæ—¶æ±‡çŽ‡è®¡ç®—å™¨",
                subtitle: "åœ¨ä¸‹æ–¹è¾“å…¥ä»»ä½•é‡‘é¢ï¼Œæ±‡çŽ‡å°†å®žæ—¶èŽ·å–ï¼",
                init_rates: "æ­£åœ¨åˆå§‹åŒ–å®žæ—¶æ±‡çŽ‡...",
                usd_label: "ç¾Žå…ƒ (USD)",
                cad_label: "åŠ å…ƒ (CAD)",
                cny_label: "äººæ°‘å¸ (CNY)",
                loading: (attempt) => `æ­£åœ¨èŽ·å–å®žæ—¶æ±‡çŽ‡... (å°è¯• ${attempt})`,
                success: "æ±‡çŽ‡æ›´æ–°æˆåŠŸï¼(æ¥æºï¼šå¼€æ”¾æ±‡çŽ‡API)",
                error_retry: (delay, attempt) => `èŽ·å–æ±‡çŽ‡å¤±è´¥ã€‚æ­£åœ¨é‡è¯•ï¼Œ${delay / 1000}ç§’åŽ... (å°è¯• ${attempt + 1})`,
                error_fallback: "ðŸ”´ å®žæ—¶æ±‡çŽ‡åŠ è½½å¤±è´¥ã€‚æ­£åœ¨ä½¿ç”¨**å›ºå®š**å¤‡ç”¨æ±‡çŽ‡ã€‚",
                loading_wait: "è¯·ç¨å€™ï¼Œæ±‡çŽ‡æ­£åœ¨åŠ è½½ä¸­...",
            }
        };

        let currentLang = 'en'; // Default language

        // --- LANGUAGE SWITCHING LOGIC ---

        /**
         * Sets the application language, updates all UI text, and saves the preference.
         * @param {string} lang - 'en' or 'zh'
         */
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('currencyConverterLang', lang);

            // 1. Update static elements (elements with data-i18n attribute)
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // 2. Update the document title
            document.querySelector('title').textContent = translations[lang].title;
            document.documentElement.lang = lang; // Set HTML lang attribute

            // 3. Update the selector to show the current language
            document.getElementById('language-selector').value = lang;

            // 4. Update dynamic messages (like rate status) if not currently loading
            const messageKey = rateMessage.getAttribute('data-i18n-dynamic');
            if (messageKey && typeof translations[lang][messageKey] === 'string') {
                rateMessage.textContent = translations[lang][messageKey];
            } else if (!loadingIndicator.classList.contains('hidden')) {
                // If it's loading, we keep the specific loading message (handled in fetchConversionRates)
            } else {
                 rateMessage.textContent = translations[lang].init_rates;
            }
        }

        // --- Live Data & Configuration (Same as before) ---
        const BASE_CURRENCY = 'USD';
        const TARGET_CURRENCIES = ['CAD', 'CNY'];
        const ALL_CURRENCIES = [BASE_CURRENCY].concat(TARGET_CURRENCIES);
        
        let RATES = {}; 
        
        // DOM elements
        const usdInput = document.getElementById('usd-input');
        const cadInput = document.getElementById('cad-input');
        const cnyInput = document.getElementById('cny-input');
        const rateInfo = document.getElementById('rate-info');
        const rateMessage = document.getElementById('rate-message');
        const loadingIndicator = document.getElementById('loading-indicator');

        const inputs = {
            'USD': usdInput,
            'CAD': cadInput,
            'CNY': cnyInput
        };

        const round = (num) => Math.round((num + Number.EPSILON) * 100) / 100;

        // --- API Integration and Fetching (MODIFIED) ---

        async function fetchConversionRates(attempt = 1) {
            const lang = currentLang;

            // Use the language-specific loading message
            rateMessage.textContent = translations[lang].loading(attempt);
            loadingIndicator.classList.remove('hidden'); 
            rateInfo.classList.remove('bg-yellow-100', 'border-yellow-300', 'bg-red-100', 'border-red-300', 'bg-green-100', 'border-green-300');
            rateInfo.classList.add('bg-blue-100', 'border-blue-300'); 
            rateMessage.setAttribute('data-i18n-dynamic', 'loading');


            const apiUrl = `https://open.er-api.com/v6/latest/${BASE_CURRENCY}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.result !== 'success') throw new Error('API request failed: ' + data.reason);

                RATES = { [BASE_CURRENCY]: 1.0 };
                TARGET_CURRENCIES.forEach(currency => {
                    if (data.rates[currency]) {
                        RATES[currency] = data.rates[currency];
                    } else {
                        console.error(`Missing rate for ${currency}`);
                        throw new Error(`Rate for ${currency} not found in API response.`);
                    }
                });

                // Update UI for success
                loadingIndicator.classList.add('hidden');
                rateInfo.classList.remove('bg-blue-100', 'border-blue-300');
                rateInfo.classList.add('bg-green-100', 'border-green-300');
                rateMessage.innerHTML = translations[lang].success;
                rateMessage.setAttribute('data-i18n-dynamic', 'success');

                console.log('Live Rates Loaded:', RATES);

            } catch (error) {
                console.error('Error fetching conversion rates:', error.message);

                if (attempt < 5) { 
                    const delay = Math.pow(2, attempt) * 1000;
                    // Use the language-specific retry message
                    rateMessage.textContent = translations[lang].error_retry(delay, attempt);
                    setTimeout(() => fetchConversionRates(attempt + 1), delay);
                } else {
                    // Final failure message
                    loadingIndicator.classList.add('hidden');
                    rateInfo.classList.remove('bg-blue-100', 'border-blue-300', 'bg-green-100', 'border-green-300');
                    rateInfo.classList.add('bg-red-100', 'border-red-300');
                    // Use the language-specific fallback message
                    rateMessage.innerHTML = translations[lang].error_fallback;
                    rateMessage.setAttribute('data-i18n-dynamic', 'error_fallback');
                    
                    // Fallback to fixed rates
                    RATES = { USD: 1.0, CAD: 1.411, CNY: 7.27 };
                }
            }
        }

        // --- Conversion Logic (Same as before) ---
        function convert(sourceCurrency) {
            if (Object.keys(RATES).length === 0) {
                rateMessage.textContent = translations[currentLang].loading_wait;
                return;
            }

            const sourceInput = inputs[sourceCurrency];
            let amount = parseFloat(sourceInput.value);

            if (isNaN(amount) || amount <= 0) {
                usdInput.value = '';
                cadInput.value = '';
                cnyInput.value = '';
                return;
            }

            const amountInUSD = amount / RATES[sourceCurrency];

            ALL_CURRENCIES.forEach(targetCurrency => {
                if (targetCurrency !== sourceCurrency) {
                    const targetValue = amountInUSD * RATES[targetCurrency];
                    inputs[targetCurrency].value = round(targetValue);
                }
            });
        }
        
        // --- Initialization (MODIFIED) ---
        function initApp() {
            // 1. Check for saved language preference
            const savedLang = localStorage.getItem('currencyConverterLang');
            const initialLang = savedLang || 'en'; 

            // 2. Set the language on the UI
            setLanguage(initialLang);

            // 3. Start fetching live rates
            fetchConversionRates();
        }
    </script>
</body>
</html>
