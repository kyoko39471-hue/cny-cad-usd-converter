<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        .input-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4" onload="initApp()">
    <div class="w-full max-w-lg p-8 space-y-6 bg-white rounded-xl input-card">
        <h1 class="text-3xl font-bold text-center text-blue-700">XX's Live Currency Calculator</h1>
        <p class="text-center text-gray-500">Enter an amount in any currency below. Rates are fetched live!</p>

        <!-- Dynamic Rate Status/Disclaimer -->
        <div id="rate-info" class="p-3 text-sm text-center bg-yellow-100 border border-yellow-300 rounded-lg flex items-center justify-center space-x-2">
            <!-- Loading message will appear here -->
            <div id="rate-message">Initializing live rates...</div>
            <div id="loading-indicator" class="loading-spinner"></div>
        </div>

        <!-- USD Input/Output -->
        <div class="space-y-2">
            <label for="usd-input" class="block text-lg font-semibold text-gray-700">United States Dollar (USD)</label>
            <input 
                type="number" 
                id="usd-input" 
                min="0"
                class="w-full p-3 text-2xl font-mono text-gray-800 border-2 border-green-300 rounded-lg focus:ring-green-500 focus:border-green-500" 
                placeholder="0.00"
                oninput="convert('USD')"
            >
        </div>

        <!-- CAD Input/Output -->
        <div class="space-y-2">
            <label for="cad-input" class="block text-lg font-semibold text-gray-700">Canadian Dollar (CAD)</label>
            <input 
                type="number" 
                id="cad-input" 
                min="0"
                class="w-full p-3 text-2xl font-mono text-gray-800 border-2 border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500" 
                placeholder="0.00"
                oninput="convert('CAD')"
            >
        </div>

        <!-- CNY Input/Output -->
        <div class="space-y-2">
            <label for="cny-input" class="block text-lg font-semibold text-gray-700">Chinese Yuan (CNY)</label>
            <input 
                type="number" 
                id="cny-input" 
                min="0"
                class="w-full p-3 text-2xl font-mono text-gray-800 border-2 border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" 
                placeholder="0.00"
                oninput="convert('CNY')"
            >
        </div>
    </div>

    <script>
        // --- Live Data & Configuration ---
        const BASE_CURRENCY = 'USD';
        const TARGET_CURRENCIES = ['CAD', 'CNY'];
        const ALL_CURRENCIES = [BASE_CURRENCY].concat(TARGET_CURRENCIES);
        
        let RATES = {}; // This object will store the live conversion rates { 'CAD': 1.41, 'CNY': 7.27 }
        
        // DOM elements
        const usdInput = document.getElementById('usd-input');
        const cadInput = document.getElementById('cad-input');
        const cnyInput = document.getElementById('cny-input');
        const rateInfo = document.getElementById('rate-info');
        const rateMessage = document.getElementById('rate-message');
        const loadingIndicator = document.getElementById('loading-indicator');

        const inputs = {
            'USD': usdInput,
            'CAD': cadInput,
            'CNY': cnyInput
        };

        // Function to round to two decimal places
        const round = (num) => Math.round((num + Number.EPSILON) * 100) / 100;

        // --- API Integration and Fetching ---

        /**
         * Fetches live exchange rates using exponential backoff.
         * The API is publicly available and allows cross-origin requests.
         * @param {number} attempt - Current retry attempt number.
         */
        async function fetchConversionRates(attempt = 1) {
            rateMessage.textContent = `Fetching live rates... (Attempt ${attempt})`;
            loadingIndicator.classList.remove('hidden'); // Show spinner
            rateInfo.classList.remove('bg-yellow-100', 'border-yellow-300', 'bg-red-100', 'border-red-300');
            rateInfo.classList.add('bg-blue-100', 'border-blue-300'); // Blue for loading

            // We use USD as the base for the API call
            const apiUrl = `https://open.er-api.com/v6/latest/${BASE_CURRENCY}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.result !== 'success') throw new Error('API request failed: ' + data.reason);

                // Populate the RATES object with the required target currencies
                RATES = { [BASE_CURRENCY]: 1.0 };
                TARGET_CURRENCIES.forEach(currency => {
                    if (data.rates[currency]) {
                        RATES[currency] = data.rates[currency];
                    } else {
                        console.error(`Missing rate for ${currency}`);
                        throw new Error(`Rate for ${currency} not found in API response.`);
                    }
                });

                // Update UI for success
                loadingIndicator.classList.add('hidden'); // Hide spinner
                rateInfo.classList.remove('bg-blue-100', 'border-blue-300');
                rateInfo.classList.add('bg-green-100', 'border-green-300');
                rateMessage.innerHTML = `Rates updated successfully! (Source: Open Exchange Rate API)`;
                
                // Log rates for debugging
                console.log('Live Rates Loaded:', RATES);

            } catch (error) {
                console.error('Error fetching conversion rates:', error.message);

                if (attempt < 5) { // Retry up to 5 times
                    const delay = Math.pow(2, attempt) * 1000; // Exponential backoff: 2s, 4s, 8s, 16s...
                    rateMessage.textContent = `Failed to fetch rates. Retrying in ${delay / 1000}s... (Attempt ${attempt + 1})`;
                    setTimeout(() => fetchConversionRates(attempt + 1), delay);
                } else {
                    // Final failure message
                    loadingIndicator.classList.add('hidden');
                    rateInfo.classList.remove('bg-blue-100', 'border-blue-300');
                    rateInfo.classList.add('bg-red-100', 'border-red-300');
                    rateMessage.innerHTML = `ðŸ”´ Failed to load live rates. Using **fixed** fallback rates.`;
                    
                    // Fallback to fixed rates (the old rates)
                    RATES = { USD: 1.0, CAD: 1.411, CNY: 7.27 };
                }
            }
        }

        // --- Conversion Logic ---

        /**
         * Converts currency from the source currency to all others.
         * @param {string} sourceCurrency - The currency being entered (e.g., 'USD').
         */
        function convert(sourceCurrency) {
            // Check if rates have been loaded (or defaulted)
            if (Object.keys(RATES).length === 0) {
                rateMessage.textContent = "Please wait, rates are still loading...";
                return;
            }

            const sourceInput = inputs[sourceCurrency];
            let amount = parseFloat(sourceInput.value);

            // Clear other inputs if the source input is empty or invalid
            if (isNaN(amount) || amount <= 0) {
                usdInput.value = '';
                cadInput.value = '';
                cnyInput.value = '';
                return;
            }

            // 1. Convert source amount to the base currency (USD)
            // Amount in USD = Source Amount / Rate of Source Currency (relative to 1 USD)
            const amountInUSD = amount / RATES[sourceCurrency];

            // 2. Convert from USD to all target currencies
            ALL_CURRENCIES.forEach(targetCurrency => {
                if (targetCurrency !== sourceCurrency) {
                    const targetValue = amountInUSD * RATES[targetCurrency];
                    inputs[targetCurrency].value = round(targetValue);
                }
            });
        }
        
        // --- Initialization ---
        
        function initApp() {
            // Start fetching live rates when the page loads
            fetchConversionRates();
        }
    </script>
</body>
</html>

